<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BuzzMusic – Proxy Stream Tester</title>
<style>
  body{margin:0;background:#141414;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:900px;margin:40px auto 140px;padding:0 16px}
  h1{color:#1db954;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  input[type=text]{flex:1;min-width:260px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#1f1f1f;color:#fff}
  button,a.btn{background:#1db954;color:#000;border:none;border-radius:8px;padding:10px 12px;font-weight:700;cursor:pointer;text-decoration:none}
  button.secondary{background:#2b2b2b;color:#fff;border:1px solid rgba(255,255,255,.12)}
  .panel{background:#171717;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin-top:16px}
  pre{background:#0f0f0f;border:1px solid rgba(255,255,255,.12);padding:8px;border-radius:8px;white-space:pre-wrap;min-height:110px}
  audio{width:100%}
  .muted{color:#bdbdbd}
</style>
</head>
<body>
<div class="wrap">
  <h1>BuzzMusic – Proxy Stream Tester</h1>
  <p class="muted">Streams through your Cloudflare Worker (HTTPS) → your home server (HTTP).</p>

  <div class="row">
    <input id="file" type="text" placeholder="Filename (e.g., CRUSH.mp3)"/>
    <button id="probe">Probe</button>
    <button id="play">Play</button>
    <a id="open" class="btn" target="_blank" rel="noreferrer">Open Direct</a>
  </div>

  <div class="panel">
    <h3>Audio</h3>
    <audio id="audio" controls crossorigin="anonymous"></audio>
  </div>

  <div class="panel">
    <h3>Diagnostics</h3>
    <pre id="out">Enter a filename and click “Probe”.</pre>
  </div>
</div>

<script>
(() => {
  // >>> SET THIS to your Worker (MUST end with /audio/)
  const PROXY_BASE = "https://YOUR-WORKER-SUBDOMAIN.workers.dev/audio/";
  // Probe endpoint is same host with /_probe
  const PROBE_BASE = PROXY_BASE.replace(/\/audio\/?$/, "/_probe?file=");

  const $ = s => document.querySelector(s);
  const file = $('#file'), audio = $('#audio'), out = $('#out'), open = $('#open');

  file.value = 'CRUSH.mp3'; // default name

  function urlFor(name){ return PROXY_BASE + encodeURIComponent((name||'').trim()); }
  function probeUrl(name){ return PROBE_BASE + encodeURIComponent((name||'').trim()); }
  function log(m){ out.textContent += (out.textContent ? "\n" : "") + m; out.scrollTop = out.scrollHeight; }
  function reset(){ out.textContent = ''; }

  $('#probe').onclick = async () => {
    reset();
    const name = file.value || 'CRUSH.mp3';
    open.href = urlFor(name);
    log('Probing origin via Worker…');
    try {
      const r = await fetch(probeUrl(name), { cache:'no-store' });
      const j = await r.json();
      log(JSON.stringify(j, null, 2));
      if (!j.ok) {
        log('❌ Not playable yet. Fix origin path/filename or connectivity.');
      } else if (j.status === 206 || j.status === 200) {
        log('✅ Origin looks good. Try Play.');
      } else {
        log('⚠️ Unexpected status; the player may still fail.');
      }
    } catch (e) {
      log('❌ Probe failed: ' + e.message);
    }
  };

  $('#play').onclick = () => {
    const name = file.value || 'CRUSH.mp3';
    const u = urlFor(name); open.href = u;
    audio.src = u;
    audio.play().catch(e => log('play() rejected: ' + e.message));
  };
})();
</script>
</body>
</html>
