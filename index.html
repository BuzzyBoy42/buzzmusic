<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BuzzMusic – Stream Tester</title>
<style>
  :root{--bg:#111827;--panel:#0f172a;--muted:#9ca3af;--accent:#1db954;--border:#263042}
  body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:28px auto 140px;padding:0 16px}
  h1{margin:0 0 8px;color:var(--accent);font-size:1.8rem}
  p.lead{margin:0 0 18px;color:#cbd5e1}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  input[type=text]{flex:1;min-width:280px;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#0b1220;color:#fff}
  button,a.btn{background:var(--accent);color:#000;border:none;border-radius:8px;padding:10px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  button.secondary{background:#263042;color:#fff;border:1px solid var(--border)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:16px}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  pre{background:#0b1220;border:1px solid var(--border);padding:8px;border-radius:8px;white-space:pre-wrap;min-height:120px}
  .warn{padding:10px;border-radius:8px;background:#3b1d1d;border:1px solid #7f1d1d;color:#fca5a5;margin:8px 0}
  .ok{padding:10px;border-radius:8px;background:#1d3b27;border:1px solid #166534;color:#86efac;margin:8px 0}
  .muted{color:var(--muted)}
  audio{width:100%}
  @media(max-width:900px){.cols{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>BuzzMusic – Stream Tester</h1>
  <p class="lead">Enter your stream URL and run the checks. Then try playback and seek.</p>

  <div class="row">
    <input id="url" type="text" placeholder="Stream URL (e.g. http://97.119.213.15:3001/stream/CRUSH.mp3)"/>
    <button id="btnCheck">Run Checks</button>
    <button id="btnPlay" class="secondary">Play in Page</button>
    <a id="btnOpen" class="btn" target="_blank" rel="noreferrer">Open Direct</a>
  </div>
  <div id="mixed" style="display:none" class="warn">⚠️ Mixed content: This page is HTTPS but your URL is HTTP. Browsers will block it. Use an HTTPS URL or put a proxy in front (e.g., Cloudflare Worker) and try again.</div>

  <div class="panel cols">
    <div>
      <h3>Fetch Diagnostics</h3>
      <pre id="out">Press “Run Checks”.</pre>
    </div>
    <div>
      <h3>Player & Events</h3>
      <audio id="audio" controls crossorigin="anonymous"></audio>
      <div class="row" style="align-items:center">
        <span class="muted">Seek to (sec):</span>
        <input id="seekVal" type="text" value="30" style="width:80px"/>
        <button id="btnSeek" class="secondary">Test Seek</button>
        <span class="muted">Volume</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:140px">
      </div>
      <pre id="events">Player events will show here…</pre>
    </div>
  </div>

  <div class="panel">
    <h3>Tips</h3>
    <ul class="muted">
      <li>404 = wrong path/filename. Your server should expose <code>/stream/&lt;file&gt;</code>.</li>
      <li>“Mixed content” = your page is HTTPS but the stream is HTTP. Use HTTPS or a proxy.</li>
      <li>For smooth seeking, server must return <code>206</code>, with <code>Accept-Ranges: bytes</code> and <code>Content-Range</code> on ranged requests.</li>
      <li>Home networks: port-forward the stream port (3001) and allow it in OS firewall.</li>
    </ul>
  </div>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const urlIn   = $('#url');
  const out     = $('#out');
  const events  = $('#events');
  const audio   = $('#audio');
  const vol     = $('#vol');
  const mixed   = $('#mixed');
  const btnOpen = $('#btnOpen');

  // Default to your URL
  urlIn.value = 'http://97.119.213.15:3001/stream/CRUSH.mp3';
  btnOpen.href = urlIn.value;

  function log(t){ out.textContent += (out.textContent ? '\n' : '') + t; out.scrollTop = out.scrollHeight; }
  function elog(t){ events.textContent += (events.textContent ? '\n' : '') + t; events.scrollTop = events.scrollHeight; }

  function checkMixed(u){
    const httpsPage = location.protocol === 'https:';
    const httpStream = /^http:\/\//i.test(u);
    mixed.style.display = (httpsPage && httpStream) ? '' : 'none';
  }

  async function head(url){
    try {
      const r = await fetch(url, { method:'HEAD', cache:'no-store' });
      log(`HEAD → ${r.status}`);
      logHeaders(r.headers);
    } catch (e) {
      log(`HEAD failed (CORS or network): ${e.message}`);
    }
  }
  async function range(url){
    try {
      const r = await fetch(url, { method:'GET', headers:{ Range:'bytes=0-1' }, cache:'no-store' });
      log(`GET Range 0-1 → ${r.status}`);
      logHeaders(r.headers);
      if (r.status === 206) log('✅ Byte-range OK (seeking will work).');
      else if (r.status === 200) log('ℹ️ 200 OK (server didn’t honor Range; seek may be limited).');
      else if (r.status === 404) log('❌ 404 Not Found — check filename/path.');
      else log('⚠️ Unexpected status.');
    } catch (e) {
      log(`Range fetch failed (CORS or network): ${e.message}`);
    }
  }
  function logHeaders(h){
    const ar = h.get('Accept-Ranges') || '(none)';
    const cr = h.get('Content-Range') || '(none)';
    const ct = h.get('Content-Type')  || '(none)';
    log(`Accept-Ranges: ${ar}`);
    log(`Content-Range: ${cr}`);
    log(`Content-Type:  ${ct}`);
  }

  // Wire up controls
  $('#btnCheck').onclick = async () => {
    out.textContent = 'Running checks…';
    const u = urlIn.value.trim();
    btnOpen.href = u;
    checkMixed(u);
    await head(u);
    await range(u);
  };

  $('#btnPlay').onclick = () => {
    events.textContent = 'Setting audio src…';
    const u = urlIn.value.trim();
    btnOpen.href = u;
    checkMixed(u);
    // attempt playback
    audio.src = u;             // if mixed content is blocked, browser will error
    audio.play().catch(e => elog(`play() rejected: ${e.message}`));
  };

  $('#btnSeek').onclick = () => {
    const s = parseFloat($('#seekVal').value || '0');
    if (isFinite(s)) {
      elog(`Seeking to ${s}s…`);
      try { audio.currentTime = s; } catch(e){ elog('Seek set failed: ' + e.message); }
    }
  };

  vol.oninput = () => audio.volume = +vol.value;

  // Player events
  ['loadstart','loadedmetadata','loadeddata','canplay','canplaythrough','play','playing','pause','stalled','waiting','seeking','seeked','ended','error','durationchange','timeupdate','progress','suspend','abort','emptied']
    .forEach(ev => audio.addEventListener(ev, () => {
      if (ev === 'error') {
        const err = audio.error;
        if (err) {
          // MediaError codes: 1=ABORTED, 2=NETWORK, 3=DECODE, 4=SRC_NOT_SUPPORTED
          elog(`error: code=${err.code}`);
        } else {
          elog('error (no detail)');
        }
      } else {
        elog(ev);
      }
    }));

  // Re-check mixed content when user edits URL
  urlIn.addEventListener('input', () => {
    btnOpen.href = urlIn.value.trim();
    checkMixed(urlIn.value.trim());
  });

  // Initial mixed-content check
  checkMixed(urlIn.value.trim());
})();
</script>
</body>
</html>
